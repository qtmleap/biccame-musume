// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// Prismaスキーマ for Cloudflare D1
generator client {
  provider        = "prisma-client-js"
  // output          = "./node_modules/.prisma/client"
  previewFeatures = ["driverAdapters"]
  engineType      = "library"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// イベント配布条件
model EventCondition {
  id             String   @id @default(uuid())
  eventId        String   @map("event_id")
  /// 配布条件の種類: purchase, first_come, lottery, everyone
  type           String
  /// 購入条件の場合の金額（円）
  purchaseAmount Int?     @map("purchase_amount")
  /// 先着または抽選の人数
  quantity       Int?
  /// 作成日時
  createdAt      DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt      DateTime @updatedAt @map("updated_at")
  event          Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_conditions")
}

/// イベント参考URL
model EventReferenceUrl {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  /// URLの種類: announce, start, end
  type      String
  url       String
  /// 作成日時
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt DateTime @updatedAt @map("updated_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_reference_urls")
}

/// イベント開催店舗（中間テーブル）
model EventStore {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  storeKey  String   @map("store_key")
  /// 作成日時
  createdAt DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt DateTime @updatedAt @map("updated_at")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, storeKey])
  @@index([eventId])
  @@map("event_stores")
}

/// イベント
model Event {
  id              String              @id @default(uuid())
  /// イベント種別: limited_card, regular_card, ackey, other
  category        String
  /// イベント名
  name            String
  /// 限定数（任意）
  limitedQuantity Int?                @map("limited_quantity")
  /// 開始日時
  startDate       DateTime            @map("start_date")
  /// 終了予定日時（任意）
  endDate         DateTime?           @map("end_date")
  /// 実際の終了日時（任意、配布が終了した実際の日時）
  endedAt         DateTime?           @map("ended_at")
  /// 公式情報として検証済みかどうか（管理者が作成/承認したもの）
  isVerified      Boolean             @default(false) @map("is_verified")
  /// 公式発表前の未確定情報かどうか
  isPreliminary   Boolean             @default(false) @map("is_preliminary")
  /// 作成日時
  createdAt       DateTime            @default(now()) @map("created_at")
  /// 更新日時
  updatedAt       DateTime            @updatedAt @map("updated_at")
  /// 配布条件
  conditions      EventCondition[]
  /// 参考URL
  referenceUrls   EventReferenceUrl[]
  /// 開催店舗
  stores          EventStore[]
  /// イベントとユーザーの関係
  userEvents      UserEvent[]

  @@map("events")
}

/// キャラクター投票
model Vote {
  id          String   @id @default(uuid())
  /// キャラクターID（例: biccame-001）
  characterId String   @map("character_id")
  /// 投票者のIPアドレス
  ipAddress   String   @map("ip_address")
  /// 投票日時
  createdAt   DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([characterId])
  @@index([ipAddress, characterId])
  @@index([createdAt])
  @@map("votes")
}

/// キャラクター投票集計
model VoteCount {
  /// キャラクターID（例: biccame-001）
  characterId String   @map("character_id")
  /// 年度（例: 2025, 2026）
  year        Int
  /// 累計投票数
  count       Int      @default(0)
  /// 投票日時
  createdAt   DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@id([characterId, year])
  @@map("vote_counts")
}

/// ユーザー
model User {
  /// Firebase Auth UID
  id           String   @id
  /// 表示名
  displayName  String?  @map("display_name")
  /// プロフィール画像URL
  thumbnailURL String?  @map("thumbnail_url")
  /// Twitterスクリーンネーム（@なし）
  screenName   String?  @map("screen_name")
  /// メールアドレス（任意）
  email        String?
  // /// メールアドレス確認済みフラグ
  // emailVerified Boolean  @default(false) @map("email_verified")
  /// 作成日時
  createdAt    DateTime @default(now()) @map("created_at")
  /// 更新日時
  updatedAt    DateTime @updatedAt @map("updated_at")

  /// 訪問した店舗
  stores UserStore[]
  /// イベントとの関係
  events UserEvent[]

  @@map("users")
}

/// ユーザーと店舗の関係
model UserStore {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  /// 店舗キー（例: biccame-001）
  storeKey  String    @map("store_key")
  /// ステータス: visited, favorite, want_to_visit等
  status    String
  /// ステータスに関連する日時（visited→訪問日時、favorite→お気に入り登録日時等）
  markedAt  DateTime? @map("marked_at")
  /// 作成日時
  createdAt DateTime  @default(now()) @map("created_at")
  /// 更新日時
  updatedAt DateTime  @updatedAt @map("updated_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, storeKey])
  @@index([userId])
  @@index([status])
  @@map("user_stores")
}

/// ユーザーとイベントの関係
model UserEvent {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  eventId     String    @map("event_id")
  /// ステータス: interested, completed
  status      String
  /// 達成日時（completedの場合）
  completedAt DateTime? @map("completed_at")
  /// 作成日時
  createdAt   DateTime  @default(now()) @map("created_at")
  /// 更新日時
  updatedAt   DateTime  @updatedAt @map("updated_at")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId, status])
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@map("user_events")
}
